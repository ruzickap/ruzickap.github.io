---
# GitHub Actions workflow for Renovate PR dependency management
# Runs Renovate on pull requests when triggered manually or via label
# Updates dependencies only for files changed in the PR
name: renovate-pr

on:
  workflow_dispatch:
    inputs:
      dryRun:
        type: boolean
        description: "Dry-Run"
      logLevel:
        type: choice
        description: "Log-Level"
        default: debug
        options:
          - info
          - debug
          - trace
  pull_request:
    types: [labeled]

env:
  # keep-sorted start
  # Set log level for debugging (info, debug, or trace) https://docs.renovatebot.com/troubleshooting/#log-debug-levels
  LOG_LEVEL: ${{ inputs.logLevel || 'debug' }}
  # Set the base branch
  RENOVATE_BASE_BRANCHES: ${{ github.head_ref }}
  # Revovate Config File
  RENOVATE_CONFIG_FILE: ".github/renovate-pr.json5"
  # Enable dry-run mode for non-main branches to preview changes (https://docs.renovatebot.com/self-hosted-configuration/#dryrun)
  # Run renovate in dry-run mode if executed in branches other than main to prevent updating versions in PRs/branches
  RENOVATE_DRY_RUN: ${{ inputs.dryRun }}
  # Target repository for Renovate to update
  # https://docs.renovatebot.com/self-hosted-configuration/#repositories
  RENOVATE_REPOSITORIES: ${{ github.repository }}
  # Username for Renovate commits
  # https://docs.renovatebot.com/self-hosted-configuration/#username
  RENOVATE_USERNAME: ${{ github.repository_owner }}
  # keep-sorted end

permissions: read-all

jobs:
  renovate-pr:
    runs-on: ubuntu-24.04-arm
    if: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'renovate-pr') }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Remove label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        run: gh api "/repos/{owner}/{repo}/issues/${PR_NUMBER}/labels/renovate-pr" --method DELETE

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@e0021407031f5be11a464abee9a0776171c79891 # v47.0.1
        with:
          files: "_posts/**"

      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        if: steps.changed-files.outputs.any_changed == 'true'
        id: app-token
        with:
          app-id: ${{ secrets.MY_RENOVATE_GITHUB_APP_ID }}
          private-key: ${{ secrets.MY_RENOVATE_GITHUB_PRIVATE_KEY }}

      - name: ðŸ’¡ Self-hosted Renovate
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: renovatebot/github-action@f7fad228a053c69a98e24f8e4f6cf40db8f61e08 # v44.2.1
        env:
          RENOVATE_INCLUDE_PATHS: ${{ steps.changed-files.outputs.all_changed_files }}
        with:
          token: ${{ steps.app-token.outputs.token }}
