---
# GitHub Actions workflow for Renovate PR dependency management
# Runs Renovate on pull requests when triggered manually or via label
# Updates dependencies only for files changed in the PR
name: renovate-pr

on:
  pull_request:
    types: [labeled]

env:
  # keep-sorted start
  # Set log level for debugging (info, debug, or trace) https://docs.renovatebot.com/troubleshooting/#log-debug-levels
  LOG_LEVEL: debug
  # Set the base branch
  RENOVATE_BASE_BRANCHES: ${{ github.head_ref }}
  # Revovate Config File
  RENOVATE_CONFIG_FILE: .github/renovate-pr.json5
  # Target repository for Renovate to update
  # https://docs.renovatebot.com/self-hosted-configuration/#repositories
  RENOVATE_REPOSITORIES: ${{ github.repository }}
  # Username for Renovate commits
  # https://docs.renovatebot.com/self-hosted-configuration/#username
  RENOVATE_USERNAME: ${{ github.repository_owner }}
  # keep-sorted end

permissions: read-all

jobs:
  renovate-pr:
    runs-on: ubuntu-24.04-arm
    if: ${{ contains(github.event.pull_request.labels.*.name, 'renovate-pr') }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Remove label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        run: gh api "/repos/{owner}/{repo}/issues/${PR_NUMBER}/labels/renovate-pr" --method DELETE

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@7dee1b0c1557f278e5c7dc244927139d78c0e22a # v47.0.4
        with:
          files: "_posts/**"
          # Use comma separator for Renovate's RENOVATE_INCLUDE_PATHS (expects comma-separated or JSON array)
          separator: ","

      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        if: steps.changed-files.outputs.any_changed == 'true'
        id: app-token
        with:
          app-id: ${{ secrets.MY_RENOVATE_GITHUB_APP_ID }}
          private-key: ${{ secrets.MY_RENOVATE_GITHUB_PRIVATE_KEY }}

      - name: ðŸ’¡ Self-hosted Renovate
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: renovatebot/github-action@8d75b92f43899d483728e9a8a7fd44238020f6e6 # v46.1.2
        env:
          RENOVATE_INCLUDE_PATHS: ${{ steps.changed-files.outputs.all_changed_files }}
        with:
          token: ${{ steps.app-token.outputs.token }}
