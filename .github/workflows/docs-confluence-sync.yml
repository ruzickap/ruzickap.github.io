---
# GitHub Actions workflow for syncing blog posts to Confluence
# Automatically syncs markdown blog posts from _posts directory to Confluence
# when changes are pushed to main branch or manually triggered
name: docs-confluence-sync

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - _posts/**/*.md

permissions:
  contents: read

env:
  CONFLUENCE_BASE_URL: https://mylabsdev.atlassian.net/wiki/
  CONFLUENCE_PARENTS: "Petr's Blog"
  CONFLUENCE_PASSWORD: "${{ secrets.MY_ATLASSIAN_PERSONAL_TOKEN }}"
  CONFLUENCE_SPACE: myspace
  CONFLUENCE_USERNAME: petr.ruzicka@gmail.com

jobs:
  docs-confluence-sync:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Get changed files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47.0.0
        id: changed-files
        with:
          separator: "\n"
          files: |
            _posts/**/*.md

      - name: Sync docs to Confluence
        if: github.event_name == 'workflow_dispatch' || steps.changed-files.outputs.any_changed == 'true'
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install mark

          # Determine which files to process
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            # For workflow_dispatch, process all markdown files
            FILES_TO_PROCESS=$(find _posts -type f -name '*.md' | sort)
          else
            # For push events, process only changed files
            FILES_TO_PROCESS="${CHANGED_FILES}"
          fi

          # Process markdown files
          while IFS= read -r FILE; do
            echo -e "\nðŸ’¡ *** Processing: ${FILE}"

            FRONT_MATTER=$(awk '/^---$/ { if (++n == 1) next; if (n == 2) exit } n == 1' "${FILE}")
            echo -e "ðŸ’¡ *** FRONT_MATTER:\n${FRONT_MATTER}"

            {
              TITLE=$(echo "${FRONT_MATTER}" | yq '.title')
              echo "<!-- Title: ${TITLE} -->"
              echo "<!-- Parent: ${FILE:7:4} -->"
              echo "<!-- Label: ${FILE:7:4} -->"

              echo "${FRONT_MATTER}" | yq -r '[.categories[], .tags[]] | unique | .[]' |
                while IFS= read -r TAG; do
                  echo "<!-- Label: ${TAG} -->"
                done
              perl -0777 -pe 's/^---\n.*?\n---\n//s' "${FILE}"
            } | sed -e 's@/assets/img/posts/@../..&@' -e 's|{%[[:space:]]*post_url[^%]*%}|http://ruzickap.github.io|g' -e 's/{:[^}]*}//' -e 's/{%[^%]*%}//' > "${FILE}-2"

            mv "${FILE}-2" "${FILE}"

            mark -f "${FILE}" --space="${CONFLUENCE_SPACE}" --parents "${CONFLUENCE_PARENTS}" \
              --changes-only --title-from-filename \
              --base-url "${CONFLUENCE_BASE_URL}" \
              --username "${CONFLUENCE_USERNAME}" \
              --password "${CONFLUENCE_PASSWORD}"
          done <<< "${FILES_TO_PROCESS}"
