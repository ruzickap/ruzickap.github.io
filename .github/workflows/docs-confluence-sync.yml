---
# GitHub Actions workflow for syncing blog posts to Confluence
# Automatically syncs markdown blog posts from _posts directory to Confluence
# when changes are pushed to main branch or manually triggered
name: docs-confluence-sync

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - _posts/**/*.md

permissions:
  contents: read

env:
  CONFLUENCE_BASE_URL: https://mylabsdev.atlassian.net
  CONFLUENCE_PARENTS: "Petr's Blog"
  CONFLUENCE_PASSWORD: "${{ secrets.MY_ATLASSIAN_PERSONAL_TOKEN }}"
  CONFLUENCE_SPACE: myspace
  CONFLUENCE_USERNAME: petr.ruzicka@gmail.com

jobs:
  docs-confluence-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Get changed files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47.0.0
        id: changed-files
        with:
          files: |
            _posts/**/*.md

      - name: Sync docs to Confluence
        if: github.event_name == 'workflow_dispatch' || steps.changed-files.outputs.any_changed == 'true'
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          set -euxo pipefail

          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install mark

          # Determine which files to process
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            # For workflow_dispatch, process all markdown files
            FILES_TO_PROCESS=$(find _posts -type f -name '*.md')
          else
            # For push events, process only changed files
            FILES_TO_PROCESS="${CHANGED_FILES}"
          fi

          # Process markdown files
          for FILE in ${FILES_TO_PROCESS}; do
            mark -f "${FILE}" --space="${CONFLUENCE_SPACE}" --parents "${CONFLUENCE_PARENTS}" \
              --title-from-h1 --changes-only \
              --base-url "${CONFLUENCE_BASE_URL}" \
              --username "${CONFLUENCE_USERNAME}" \
              --password "${CONFLUENCE_PASSWORD}"
          done
